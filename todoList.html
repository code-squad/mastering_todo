<script>
const todoListArr = [];  //{id = ##, title = #####, state=#### ,startTime = ####, finishTime = ######}
const TODO_INFO_INDEX = {
    //#1. when command add
    TODO_COMMAND_INDEX : 0,
    TODO_ADD_TITLE : 1,
    //#2. when command update
    TODO_UPDATE_ID_INDEX : 1,
    TODO_UPDATE_STATE : 2,
    //#3. when command show
    TODO_SHOW_STATE : 1
};
const TASK_STATE = {
    STATE_TODO : 'todo',
    STATE_DOING : 'doing',
    STATE_DONE : 'done'
};
const COMMAND_OPTION = {
    COMMAND_ADD : 'add',
    COMMAND_UPDATE : 'update',
    COMMAND_SHOW : 'show'
};
//#0. common functions
//새로 Task 등록 시 필요한 ID값 리턴
const getNewTaskId = () => todoListArr.length + 1;
//각 state 별 Count값을 가지는 Object 리턴
const getStateGroupCountObject = () => {
    const outputObj = {};
    Object.keys(TASK_STATE).forEach((key,index) =>{
        outputObj[TASK_STATE[key]] = 0;
        todoListArr.forEach((mapInfo, index) => {
            if(mapInfo.state === TASK_STATE[key]){
                outputObj[TASK_STATE[key]]++;
            }
        });
    });

    return outputObj;
};
// doing -> done까지 소요 시간 출력 ##시간##분##초초
const getWorkingHoursFormat = (startTime, finishTime = Date.now()) => {
    const TIME_CONVERT_VALUE = {
        SECONDS : {FACTOR : 1000, CONSUME : 0},
        MINUTES : {FACTOR : 60, CONSUME : 0},
        HOURS   : {FACTOR : 60, CONSUME : 0}
    };

    if(startTime === undefined) return -1;
    
    //소요시간을 초로 계산산
    let divideValue = TIME_CONVERT_VALUE.SECONDS.FACTOR;
    let consumeTime = (finishTime - startTime) / divideValue;
    
    //#1. 소요시간을 구함
    divideValue = TIME_CONVERT_VALUE.MINUTES.FACTOR * TIME_CONVERT_VALUE.HOURS.FACTOR;
    TIME_CONVERT_VALUE.HOURS.CONSUME = Math.floor(consumeTime / divideValue);

    //#2. 소요시간값을 제외한 나머지 분을 구함
    consumeTime %= divideValue;
    divideValue = TIME_CONVERT_VALUE.HOURS.FACTOR;
    TIME_CONVERT_VALUE.MINUTES.CONSUME = Math.floor(consumeTime / divideValue);

    //#3. 소요 시간 & 분을 제외한 나머지 초를 구함
    TIME_CONVERT_VALUE.SECONDS.CONSUME = Math.floor(consumeTime % divideValue);

    let returnStr = "";
    if(TIME_CONVERT_VALUE.HOURS.CONSUME > 0) returnStr += TIME_CONVERT_VALUE.HOURS.CONSUME + "시간";
    if(TIME_CONVERT_VALUE.MINUTES.CONSUME > 0) returnStr += TIME_CONVERT_VALUE.MINUTES.CONSUME + "분";
    if(TIME_CONVERT_VALUE.SECONDS.CONSUME > 0) returnStr += TIME_CONVERT_VALUE.SECONDS.CONSUME + "초";
    return returnStr;
};
// 각 명령어 별 안내사항 출력
const printDetailInfoWithCommand = (commandStr, filteredMap = null) => {
    const countObj = getStateGroupCountObject();
    if(commandStr === COMMAND_OPTION.COMMAND_ADD){
        console.log(`현재상태 : todo:${countObj.todo}개, doing:${countObj.doing}개, done:${countObj.done}개`);
    }else if(commandStr === COMMAND_OPTION.COMMAND_SHOW){
        if(filteredMap === null || filteredMap.length === 0){
            console.log("요청하신 Show 명령어에 대한 Task가 없습니다.");
        }else{
            let showPrintStr = "";
            filteredMap.forEach((mapInfo, index) => {
                index > 0 ? showPrintStr += `,` : ``;
                showPrintStr += `'${mapInfo.id}, ${mapInfo.title}` 
                showPrintStr += (mapInfo.state === TASK_STATE.STATE_DONE) ? ", "+getWorkingHoursFormat(mapInfo.startTime, mapInfo.finishTime)+"'" : "'";
            });
            console.log(showPrintStr);
        }
    }else if(commandStr === COMMAND_OPTION.COMMAND_UPDATE){
        console.log(`현재상태 : todo:${countObj.todo}개, doing:${countObj.doing}개, done:${countObj.done}개`);
    }else{
        console.log("exception error!!!");
    }
};
//update 시 대상 Target return
const getTargetObjWithID = (updateId) => {
    let targetObj;
    todoListArr.some((todoInfo, index) => {
        if(todoInfo.id === updateId){
            targetObj = todoInfo;
            targetObj.index = index;
            return true;
        }
    })
    return targetObj;
};

//update 작업 완료 후 todoListArr 값 replace
const replaceTargetObjToList = (targetObj) => {
    const targetIndex = targetObj.index;
    delete targetObj.index;
    Object.assign(
        [...todoListArr], 
        {targetIndex : targetObj}
    );
};

//#1. todoList 명령어 $ split
const splitCommandLine = (commandStr, separator = "$") => commandStr.split(separator);

//#2. 명령어와 옵션 공백제거 & lowerCase
const rearrangeCommandOptions = (optionArr) => optionArr.map(option => option.trim().toLowerCase());

//#3. 사용자 입력 명령어에 따른 작업 수행
const impleAddCommand = (optionArr) => {
    const jobObj = {};
    jobObj.id = getNewTaskId();
    jobObj.title = optionArr[TODO_INFO_INDEX.TODO_ADD_TITLE];
    jobObj.state = TASK_STATE.STATE_TODO;
    todoListArr.push(jobObj);
    console.log(`id : ${jobObj.id}, \"${jobObj.title}\" 항목이 새로 추가됐습니다.`);
};

const impleUpdateCommand = (optionArr) => {
    //#1. update ID에 맞는 todo task 찾기
    const updateTargetObj = getTargetObjWithID(parseInt(optionArr[TODO_INFO_INDEX.TODO_UPDATE_ID_INDEX]));
    if(!updateTargetObj) return false;

    //#2. 찾은 Ojbect state 변경하기
    const updateState = optionArr[TODO_INFO_INDEX.TODO_UPDATE_STATE];
    const priorState = updateTargetObj.state;

    //#2-1. TASK_STATE가 가지고 있는 값과 동일한 update state 입력여부 확인
    Object.keys(TASK_STATE).forEach((key,index) =>{
        if(updateState === TASK_STATE[key]){
            updateTargetObj.state = TASK_STATE[key];
        }
    });


    //#3. state에 따른 추가 정보 변경
    if(updateTargetObj.state === priorState) {
        return false;
    }else{
        if(updateTargetObj.state === TASK_STATE.STATE_DOING){
            //state = doing, set startTime value
            updateTargetObj.startTime = Date.now();
        }else if(updateTargetObj.state === TASK_STATE.STATE_DONE){
            //state = done, set startTimeValue
            updateTargetObj.finishTime = Date.now();
        }else{
            //state = todo
            console.log(priorState + '상태에서 todo 상태로 되돌릴 수 없습니다.');
            return false;
        }
    }

    //#4. update todoListArr with updateTargetObj
    replaceTargetObjToList(updateTargetObj);

};

const impleShowCommand = (optionArr) => {
    const chosenShowState = optionArr[TODO_INFO_INDEX.TODO_SHOW_STATE];
    const filterArr = todoListArr.filter(todoInfo => todoInfo.state === chosenShowState);
    return filterArr;
};


const todoJobCurry = (firstFunc) => (...firstArgs) => secondFunc => (...secondArgs) =>{ 
    firstFuncReturn = firstFunc(...firstArgs);

    if(firstFuncReturn !== undefined && firstFuncReturn !== false) {
        secondFunc(...secondArgs, firstFuncReturn);
    }else{
        if(firstFuncReturn === false){
            console.log('입력하신 내용이 바르지 않습니다.');
        }else{
            secondFunc(...secondArgs);
        }
    }
};

const updateUserToDoList = (optionArr) => {
    const commandStr = optionArr[TODO_INFO_INDEX.TODO_COMMAND_INDEX];
    let todoJobCurryImple;
    if(commandStr === COMMAND_OPTION.COMMAND_ADD){
        //명령어가 add 일 때 
        todoJobCurryImple = todoJobCurry(impleAddCommand)(optionArr);

    }else if(commandStr === COMMAND_OPTION.COMMAND_SHOW){
        //명령어가 show 일 때 
        todoJobCurryImple = todoJobCurry(impleShowCommand)(optionArr);

    }else if(commandStr === COMMAND_OPTION.COMMAND_UPDATE){
        //명령어가 update 일 때 
        todoJobCurryImple = todoJobCurry(impleUpdateCommand)(optionArr);

    }else{
        //기타 명령어가 들어왔을 때
        todoJobCurryImple = todoJobCurry(function(){
            console.log("없는 명령어입니다.");
        })();
    }

    todoJobCurryImple(printDetailInfoWithCommand)(commandStr)
};

const commandPipe = (...functions) => args => {
   return functions.reduce((arg, nextFn) => nextFn(arg), args); 
};

const command = (commandStr) => {
    commandPipe(
       //#1. $ split
       splitCommandLine,
       //#2. 각 항목 공백 제거 , #3. 명령어 toLowerCase
       rearrangeCommandOptions,
       //#3. 사용자 입력 명령어에 따른 작업 수행
       updateUserToDoList
    )(commandStr);
};
</script>